<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Download, explore, interactively visualize, and perform a supervised classification using NEON AOP bidirectional reflectance data and TOS vegetation structure data.">

<title>Tree Classification with NEON Airborne Imaging Spectrometer Data using Python xarray – NEON AOP &amp; NASA AVIRIS Airborne and Field Data Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../resources/additional_resources.html" rel="next">
<link href="../neon/01_make-classification-training-df.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-bb05f5d0074da2129d766b238819cd35.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-cb4c65b174a86268c128f8f7175eb5ec.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-bb05f5d0074da2129d766b238819cd35.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../neon/01_make-classification-training-df.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../neon/02_neon-refl-classification.html">2 NEON - Reflectance Visualization and Classification</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../img/neon_ornl_daac_earthdata_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">NEON AOP &amp; NASA AVIRIS Airborne Hyperspectral Data Workshop</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://NEONScience.github.io/neon-nasa-hsi-workshop/" title="NEON NASA Hyperspectral Workshop Website" class="quarto-navigation-tool px-1" aria-label="NEON NASA Hyperspectral Workshop Website"><i class="bi bi-globe"></i></a>
    <a href="https://github.com/NEONScience/neon-nasa-hsi-workshop" title="NEON NASA Repository" class="quarto-navigation-tool px-1" aria-label="NEON NASA Repository"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Welcome</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2025 ESA Workshop</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../neon-nasa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Repository Description</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../instructor-bios.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instructors</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Setup Instructions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup/prerequisites.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prerequisites</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup/workshop_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cloud Workspace Setup</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Background</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../background/neon_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NEON Airborne Data Background</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../background/nasa_airborne_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NASA Airborne Data Background</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../background/nasa_neon_comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Comparing NEON and NASA Airborne Campaigns</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../neon/01_make-classification-training-df.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 NEON - Make a Training Dataset from Vegetation Structure Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../neon/02_neon-refl-classification.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">2 NEON - Reflectance Visualization and Classification</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Resources</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../resources/additional_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Additional Resources</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Code of Conduct</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../CODE_OF_CONDUCT.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NEON’s Code of Conduct</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">1. Setup</a>
  <ul class="collapse">
  <li><a href="#import-python-packages" id="toc-import-python-packages" class="nav-link" data-scroll-target="#import-python-packages">1.1 Import Python Packages</a></li>
  <li><a href="#set-your-neon-token" id="toc-set-your-neon-token" class="nav-link" data-scroll-target="#set-your-neon-token">1.2 Set your NEON Token</a></li>
  </ul></li>
  <li><a href="#visualize-neon-aop-os-and-is-shapefiles-at-serc" id="toc-visualize-neon-aop-os-and-is-shapefiles-at-serc" class="nav-link" data-scroll-target="#visualize-neon-aop-os-and-is-shapefiles-at-serc">2. Visualize NEON AOP, OS, and IS shapefiles at SERC</a>
  <ul class="collapse">
  <li><a href="#neon-aop-flight-box-boundary" id="toc-neon-aop-flight-box-boundary" class="nav-link" data-scroll-target="#neon-aop-flight-box-boundary">2.1 NEON AOP flight box boundary</a></li>
  <li><a href="#neon-os-terrestrial-sampling-boundaries" id="toc-neon-os-terrestrial-sampling-boundaries" class="nav-link" data-scroll-target="#neon-os-terrestrial-sampling-boundaries">2.2 NEON OS terrestrial sampling boundaries</a></li>
  <li><a href="#neon-is-tower-footprint-boundaries" id="toc-neon-is-tower-footprint-boundaries" class="nav-link" data-scroll-target="#neon-is-tower-footprint-boundaries">2.3 NEON IS tower footprint boundaries</a></li>
  <li><a href="#visualize-aop-os-and-is-boundaries-together" id="toc-visualize-aop-os-and-is-boundaries-together" class="nav-link" data-scroll-target="#visualize-aop-os-and-is-boundaries-together">2.4 Visualize AOP, OS, and IS boundaries together</a></li>
  </ul></li>
  <li><a href="#find-available-neon-reflectance-data-and-download" id="toc-find-available-neon-reflectance-data-and-download" class="nav-link" data-scroll-target="#find-available-neon-reflectance-data-and-download">3. Find available NEON reflectance data and download</a>
  <ul class="collapse">
  <li><a href="#find-available-data" id="toc-find-available-data" class="nav-link" data-scroll-target="#find-available-data">3.1 Find available data</a></li>
  <li><a href="#download-neon-lidar-data-using-neonutilities-by_file_aop" id="toc-download-neon-lidar-data-using-neonutilities-by_file_aop" class="nav-link" data-scroll-target="#download-neon-lidar-data-using-neonutilities-by_file_aop">3.2 Download NEON Lidar data using neonutilities by_file_aop</a></li>
  <li><a href="#download-neon-reflectance-data-using-neonutilities-by_tile_aop" id="toc-download-neon-reflectance-data-using-neonutilities-by_tile_aop" class="nav-link" data-scroll-target="#download-neon-reflectance-data-using-neonutilities-by_tile_aop">3.3 Download NEON Reflectance Data using neonutilities by_tile_aop</a></li>
  </ul></li>
  <li><a href="#read-in-and-visualize-reflectance-data-interactively" id="toc-read-in-and-visualize-reflectance-data-interactively" class="nav-link" data-scroll-target="#read-in-and-visualize-reflectance-data-interactively">4. Read in and visualize reflectance data interactively</a>
  <ul class="collapse">
  <li><a href="#convert-reflectance-data-to-an-xarray-dataset" id="toc-convert-reflectance-data-to-an-xarray-dataset" class="nav-link" data-scroll-target="#convert-reflectance-data-to-an-xarray-dataset">4.1 Convert Reflectance Data to an xarray Dataset</a></li>
  <li><a href="#visualize-the-reflectance-dataset" id="toc-visualize-the-reflectance-dataset" class="nav-link" data-scroll-target="#visualize-the-reflectance-dataset">4.2 Visualize the reflectance dataset</a></li>
  <li><a href="#plot-the-reflectance-dataset" id="toc-plot-the-reflectance-dataset" class="nav-link" data-scroll-target="#plot-the-reflectance-dataset">4.3 Plot the reflectance dataset</a></li>
  <li><a href="#plot-the-weather-quality-indicator-data" id="toc-plot-the-weather-quality-indicator-data" class="nav-link" data-scroll-target="#plot-the-weather-quality-indicator-data">4.4 Plot the weather quality indicator data</a></li>
  <li><a href="#plot-a-false-color-image" id="toc-plot-a-false-color-image" class="nav-link" data-scroll-target="#plot-a-false-color-image">4.5 Plot a false color image</a></li>
  <li><a href="#make-an-interactive-spectral-signature-plot" id="toc-make-an-interactive-spectral-signature-plot" class="nav-link" data-scroll-target="#make-an-interactive-spectral-signature-plot">4.6 Make an interactive spectral signature plot</a></li>
  </ul></li>
  <li><a href="#supervised-classification-using-tos-vegetation-structure-data" id="toc-supervised-classification-using-tos-vegetation-structure-data" class="nav-link" data-scroll-target="#supervised-classification-using-tos-vegetation-structure-data">5. Supervised Classification Using TOS Vegetation Structure Data</a>
  <ul class="collapse">
  <li><a href="#read-in-the-training-data" id="toc-read-in-the-training-data" class="nav-link" data-scroll-target="#read-in-the-training-data">5.1 Read in the training data</a></li>
  <li><a href="#inspect-the-training-data" id="toc-inspect-the-training-data" class="nav-link" data-scroll-target="#inspect-the-training-data">5.2 Inspect the training data</a></li>
  <li><a href="#set-up-the-random-forest-model-to-classify-tree-families" id="toc-set-up-the-random-forest-model-to-classify-tree-families" class="nav-link" data-scroll-target="#set-up-the-random-forest-model-to-classify-tree-families">5.3 Set up the Random Forest Model to Classify Tree Families</a></li>
  <li><a href="#prepare-and-clean-the-training-data" id="toc-prepare-and-clean-the-training-data" class="nav-link" data-scroll-target="#prepare-and-clean-the-training-data">5.4 Prepare and clean the training data</a></li>
  <li><a href="#encode-the-target-variable" id="toc-encode-the-target-variable" class="nav-link" data-scroll-target="#encode-the-target-variable">5.5 Encode the target variable</a></li>
  <li><a href="#split-the-data-into-training-and-testing-sets" id="toc-split-the-data-into-training-and-testing-sets" class="nav-link" data-scroll-target="#split-the-data-into-training-and-testing-sets">5.6 Split the data into training and testing sets</a></li>
  <li><a href="#create-a-random-forest-classifier-object" id="toc-create-a-random-forest-classifier-object" class="nav-link" data-scroll-target="#create-a-random-forest-classifier-object">5.7 Create a Random Forest Classifier Object</a></li>
  <li><a href="#evaluate-the-model" id="toc-evaluate-the-model" class="nav-link" data-scroll-target="#evaluate-the-model">5.8 Evaluate the Model</a></li>
  </ul></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a>
  <ul class="collapse">
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements">Acknowledgements</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../neon/01_make-classification-training-df.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../neon/02_neon-refl-classification.html">2 NEON - Reflectance Visualization and Classification</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Tree Classification with NEON Airborne Imaging Spectrometer Data using Python xarray</h1>
</div>

<div>
  <div class="description">
    Download, explore, interactively visualize, and perform a supervised classification using NEON AOP bidirectional reflectance data and TOS vegetation structure data.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Bridget Hass </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div id="ds-objectives" data-markdown="1">
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<p>The National Ecological Observatory Network (NEON) Airborne Observation Platform (AOP) collects airborne remote sensing data, including hyperspectral reflectance data, over 81 sites across the United States and Puerto Rico. In this notebook we will show how to download and visualize reflectance data from NEON’s <a href="https://www.neonscience.org/field-sites/serc">Smithsonian Environmental Research Center</a> site (SERC) in Maryland. We will then demonstrate how to run a supervised classification using the NEON Observational System (OS) Vegetation Structure data as training data, and evaluate the model results.</p>
</section>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>The <strong>NEON Imaging Spectrometer (NIS)</strong> is an airborne <a href="https://www.neonscience.org/data-collection/imaging-spectrometer">imaging spectrometer</a> built by JPL (AVIRIS-NG) and operated by the National Ecological Observatory Network’s (NEON) Airborne Observation Platform (AOP). NEON’s hyperspectral sensors collect measurements of sunlight reflected from the Earth’s surface in 426 narrow (~5 nm) spectral channels spanning wavelengths between ~ 380 - 2500 nm. NEON’s remote sensing data is intended to map and answer questions about a landscape, with ecological applications including identifying and classifying plant species and communities, mapping vegetation health, detecting disease or invasive species, and mapping droughts, wildfires, or other natural disturbances and their impacts.</p>
<p>In 2024, NEON started producing bidirectional reflectance data products (including BRDF and topographic corrections). These are currently available for AOP data collected between 2022-2025. For more details on this newly revised data product, please refer to the tutorial: <a href="https://www.neonscience.org/resources/learning-hub/tutorials/neon-brdf-refl-h5-py">Introduction to Bidirectional Hyperspectral Reflectance Data in Python</a>.</p>
<p>NEON surveys sites spanning the continental US, during peak phenological greenness, capturing each site 3 out of every 5 years, for most terrestrial sites. AOP’s <a href="https://www.neonscience.org/data-collection/flight-schedules-coverage">Flight Schedules and Coverage</a> provide’s more information about the current and past schedules.</p>
<p>More detailed information about NEON’s airborne sampling design can be found in the paper: <a href="https://besjournals.onlinelibrary.wiley.com/doi/10.1111/2041-210X.13942">Spanning scales: The airborne spatial and temporal sampling design of the National Ecological Observatory Network</a>.</p>
</section>
<section id="set-up-python-environment" class="level3">
<h3 class="anchored" data-anchor-id="set-up-python-environment">Set Up Python Environment</h3>
<ul>
<li><p><em>No Python setup requirements if connected to the workshop Openscapes cloud instance!</em></p></li>
<li><p><strong>Local Only</strong></p></li>
</ul>
<p>Using your preferred command line interface (command prompt, terminal, etc.) navigate to your local copy of the repository, then type the following to create a compatible Python environment.</p>
<pre><code>For Windows:

```cmd
conda create -n neon_aop -c conda-forge --yes python=3.10 fiona=1.8.22 gdal hvplot geoviews rioxarray rasterio geopandas jupyter jupyter_bokeh jupyterlab h5py spectral scikit-image scikit-learn seaborn neonutilities
```

For MacOSX:

```cmd
conda create -n neon_aop -c conda-forge --yes python=3.10 gdal=3.7.2 hvplot geoviews rioxarray rasterio geopandas fiona=1.9.4 jupyter jupyter_bokeh jupyterlab h5py spectral scikit-image scikit-learn seaborn neonutilities
```</code></pre>
</section>
<section id="create-a-neon-aop-token" class="level3">
<h3 class="anchored" data-anchor-id="create-a-neon-aop-token">Create a NEON AOP Token</h3>
<ul>
<li>NEON API Token (optional, but strongly recommended), see <a href="https://www.neonscience.org/resources/learning-hub/tutorials/neon-api-tokens-tutorial">NEON API Tokens Tutorial</a> for more details on how to create and set up your token in Python (and R). Once you create your token (on the <a href="https://www.neonscience.org/about/user-accounts">NEON User Accounts</a>) page, this notebook will show you how to set it as an environment variable and use it for downloading AOP data.</li>
</ul>
</section>
<section id="optional-download-neon-shapefiles" class="level3">
<h3 class="anchored" data-anchor-id="optional-download-neon-shapefiles">Optional: Download NEON Shapefiles</h3>
<p>The lesson shows how to programmatically download the NEON shapefiles, but you can also download them by clicking on the following links:</p>
<ul>
<li>AOP Flight Box Boundaries: <a href="https://www.neonscience.org/sites/default/files/AOP_flightBoxes_0.zip" class="link--button link--arrow">AOP_FlightBoxes.zip</a></li>
<li>TOS Sampling Boundaries: <a href="https://www.neonscience.org/sites/default/files/Field_Sampling_Boundaries_202503.zip" class="link--button link--arrow">TOS_SamplingBoundaries.zip</a></li>
</ul>
</section>
<section id="learning-objectives" class="level3">
<h3 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h3>
<ul>
<li>Explore NEON airborne and field (instrumented, observational) shapefiles to understand what colloated data are available</li>
<li>Use the neonutilities package to determine available reflectance data and download</li>
<li>Use a custom function to convert reflectance data into an xarray dataset</li>
<li>Create some interactive visualizations of reflectance data</li>
<li>Run a random forest model to classify trees using reflectance data and data generated from vegetation structure (as the training data set)</li>
<li>Evaluate classification model results</li>
<li>Understand data QA considerations and potential steps to improve classification results</li>
</ul>
</section>
<section id="tutorial-outline" class="level3">
<h3 class="anchored" data-anchor-id="tutorial-outline">Tutorial Outline</h3>
<ol type="1">
<li>Setup</li>
<li>Visualize NEON AOP, OS, and IS shapefiles at SERC</li>
<li>Find available NEON reflectance data at SERC and download</li>
<li>Read in and visualize reflectance data interactively</li>
<li>Create a random forest model to predict the tree families from the reflectance spectra</li>
</ol>
</section>
</div>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">1. Setup</h2>
<section id="import-python-packages" class="level3">
<h3 class="anchored" data-anchor-id="import-python-packages">1.1 Import Python Packages</h3>
<p>If not already installed, install the <code>neonutilities</code> and <code>python-dotenv</code> packages using <code>pip</code> as follows: - <code>!pip install neonutilities</code> - <code>!pip install python-dotenv</code></p>
<div id="cell-4" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import required libraries, grouped by functionality</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># --- System and utility packages ---</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> timedelta</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dotenv</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> zipfile <span class="im">import</span> ZipFile</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Data handling and scientific computing ---</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Geospatial and multi-dimensional raster data ---</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> h5py</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio <span class="im">as</span> rio  <span class="co"># work with geospatial raster data</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr  <span class="co"># work with raster arrays</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely <span class="im">import</span> geometry</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry.polygon <span class="im">import</span> orient</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> osgeo <span class="im">import</span> gdal  <span class="co"># work with raster and vector geospatial data</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Plotting and visualization ---</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> holoviews <span class="im">as</span> hv</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hvplot.xarray  <span class="co"># plot multi-dimensional arrays</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co"># --- neonutilities ---</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> neonutilities <span class="im">as</span> nu</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-your-neon-token" class="level3">
<h3 class="anchored" data-anchor-id="set-your-neon-token">1.2 Set your NEON Token</h3>
<p>Define your token. You can set this up on your NEON user account page, https://data.neonscience.org/myaccount. Please refer to the <a href="https://www.neonscience.org/resources/learning-hub/tutorials/neon-api-tokens-tutorial">NEON API Tokens Tutorial</a> for more details on how to create and set up your token in Python (and R).</p>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># method 1: set the NEON_TOKEN directly in your code</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>NEON_TOKEN<span class="op">=</span><span class="st">'YOUR_TOKEN_HERE'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># method 2: set the token as an environment variable using the dotenv package</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>dotenv.set_key(dotenv_path<span class="op">=</span><span class="st">".env"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>key_to_set<span class="op">=</span><span class="st">"NEON_TOKEN"</span>,<span class="co">#</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>value_to_set<span class="op">=</span><span class="st">"YOUR_TOKEN_HERE"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># to retrieve the token that you set as an environment variable, use:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>NEON_TOKEN<span class="op">=</span>os.environ.get(<span class="st">"NEON_TOKEN"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="visualize-neon-aop-os-and-is-shapefiles-at-serc" class="level2">
<h2 class="anchored" data-anchor-id="visualize-neon-aop-os-and-is-shapefiles-at-serc">2. Visualize NEON AOP, OS, and IS shapefiles at SERC</h2>
<p>In this next section, we will look at some of the NEON spatial data, honing in on our site of interest (SERC). We will look at the AOP flight box (the area over which the NEON AOP platform flies, including multiple priority boxes), the IS tower airshed, and the OS terrestrial sampling boundaries. This will provide an overview of how the NEON sites are set up, and the spatial overlap between the field and airborne data.</p>
<p>First, let’s define a function that will download data from a url. We will use this to download shapefile boundares of the NEON AOP flight boxes, as well as the IS and OS shapefiles in order to see the spatial extent of the various data samples that NEON collects.</p>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to download data stored on the internet in a public url to a local file</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_url(url,download_dir):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.isdir(download_dir):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        os.makedirs(download_dir)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> url.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> requests.get(url, allow_redirects<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    file_object <span class="op">=</span> <span class="bu">open</span>(os.path.join(download_dir,filename),<span class="st">'wb'</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    file_object.write(r.content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="neon-aop-flight-box-boundary" class="level3">
<h3 class="anchored" data-anchor-id="neon-aop-flight-box-boundary">2.1 NEON AOP flight box boundary</h3>
<p>Download, Unzip, and Open the shapefile (.shp) containing the AOP flight box boundaries, which can also be downloaded from <a href="https://www.neonscience.org/data-samples/data/spatial-data-maps">NEON Spatial Data and Maps</a>. Read this shapefile into a <code>geodataframe</code>, explore the contents, and check the coordinate reference system (CRS) of the data.</p>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and Unzip the NEON Flight Boundary Shapefile</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>aop_flight_boundary_url <span class="op">=</span> <span class="st">"https://www.neonscience.org/sites/default/files/AOP_flightBoxes_0.zip"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use download_url function to save the file to a directory</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">'./data/shapefiles'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>download_url(aop_flight_boundary_url,<span class="st">'./data/shapefiles'</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Unzip the file</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ZipFile(<span class="ss">f"./data/shapefiles/</span><span class="sc">{</span>aop_flight_boundary_url<span class="sc">.</span>split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(<span class="st">'./data/shapefiles'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>aop_flightboxes <span class="op">=</span> gpd.read_file(<span class="st">"./data/shapefiles/AOP_flightBoxes/AOP_flightboxesAllSites.shp"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>aop_flightboxes.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, let’s examine the AOP flightboxes polygons at the SERC site.</p>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>site_id <span class="op">=</span> <span class="st">'SERC'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>aop_flightboxes[aop_flightboxes.siteID <span class="op">==</span> site_id]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see the site <code>geodataframe</code> consists of a single polygon, that we want to include in our study site (sometimes NEON sites may have more than one polygon, as there are sometimes multiple areas, with different priorities for collection).</p>
<div id="cell-16" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write this to a new variable called "site_polygon"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>site_aop_polygon <span class="op">=</span> aop_flightboxes[aop_flightboxes.siteID <span class="op">==</span> site_id]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># subset to only include columns of interest</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>site_aop_polygon <span class="op">=</span> site_aop_polygon[[<span class="st">'domain'</span>,<span class="st">'siteName'</span>,<span class="st">'siteID'</span>,<span class="st">'sampleType'</span>,<span class="st">'flightbxID'</span>,<span class="st">'priority'</span>,<span class="st">'geometry'</span>]]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the flightbxID column to flightboxID for clarity</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>site_aop_polygon <span class="op">=</span> site_aop_polygon.rename(columns<span class="op">=</span>{<span class="st">'flightbxID'</span>:<span class="st">'flightboxID'</span>})</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>site_aop_polygon <span class="co"># display site polygon</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we can visualize our region of interest (ROI) and the exterior boundary polygon containing ROIs.</p>
<p>Now let’s define a function that uses folium to display the bounding box polygon on a map. We will first use this function to visualize the AOP flight box polygon, and then we will use it to visualize the IS and OS polygons as well.</p>
<div id="cell-19" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_folium_shapes(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    shapefiles,      <span class="co"># list of file paths or GeoDataFrames</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    styles<span class="op">=</span><span class="va">None</span>,     <span class="co"># list of style dicts for each shapefile</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    names<span class="op">=</span><span class="va">None</span>,      <span class="co"># list of names for each shapefile</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    map_center<span class="op">=</span><span class="va">None</span>, <span class="co"># [lat, lon]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    zoom_start<span class="op">=</span><span class="dv">12</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pyproj</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no center is provided, use the centroid of the first shapefile (projected)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> map_center <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(shapefiles[<span class="dv">0</span>], <span class="bu">str</span>):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            gdf <span class="op">=</span> gpd.read_file(shapefiles[<span class="dv">0</span>])</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>            gdf <span class="op">=</span> shapefiles[<span class="dv">0</span>]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project to Web Mercator (EPSG:3857) for centroid calculation</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        gdf_proj <span class="op">=</span> gdf.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        centroid <span class="op">=</span> gdf_proj.geometry.centroid.iloc[<span class="dv">0</span>]</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert centroid back to lat/lon</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        lon, lat <span class="op">=</span> gpd.GeoSeries([centroid], crs<span class="op">=</span><span class="st">"EPSG:3857"</span>).to_crs(epsg<span class="op">=</span><span class="dv">4326</span>).geometry.iloc[<span class="dv">0</span>].coords[<span class="dv">0</span>]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        map_center <span class="op">=</span> [lat, lon]</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> folium.Map(</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        location<span class="op">=</span>map_center,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        zoom_start<span class="op">=</span>zoom_start,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        tiles<span class="op">=</span><span class="va">None</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    folium.TileLayer(</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        tiles<span class="op">=</span><span class="st">'https://mt1.google.com/vt/lyrs=y&amp;x=</span><span class="sc">{x}</span><span class="st">&amp;y=</span><span class="sc">{y}</span><span class="st">&amp;z=</span><span class="sc">{z}</span><span class="st">'</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        attr<span class="op">=</span><span class="st">'Google'</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">'Google Satellite'</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    ).add_to(m)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, shp <span class="kw">in</span> <span class="bu">enumerate</span>(shapefiles):</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(shp, <span class="bu">str</span>):</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            gdf <span class="op">=</span> gpd.read_file(shp)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>            gdf <span class="op">=</span> shp</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        style <span class="op">=</span> styles[i] <span class="cf">if</span> styles <span class="kw">and</span> i <span class="op">&lt;</span> <span class="bu">len</span>(styles) <span class="cf">else</span> {}</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        layer_name <span class="op">=</span> names[i] <span class="cf">if</span> names <span class="kw">and</span> i <span class="op">&lt;</span> <span class="bu">len</span>(names) <span class="cf">else</span> <span class="ss">f"Shape </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        folium.GeoJson(</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            gdf,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>layer_name,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            style_function<span class="op">=</span><span class="kw">lambda</span> x, style<span class="op">=</span>style: style,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            tooltip<span class="op">=</span>layer_name</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        ).add_to(m)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    folium.LayerControl().add_to(m)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>map1 <span class="op">=</span> plot_folium_shapes(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    shapefiles<span class="op">=</span>[site_aop_polygon],</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    names<span class="op">=</span>[<span class="st">'NEON AOP Flight Bounding Box'</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>map1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<figure class="figure">
<a href="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/hyperspectral-classification/xarray/serc_aop_flightbox.png"> <img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/hyperspectral-classification/xarray/serc_aop_flightbox.png" alt="AOP SERC Flight Box" style="max-width: 100%; height: auto;" class="figure-img">
<figcaption>
AOP flight box polygon at the SERC site.
</figcaption>
</a>
</figure>
</section>
<section id="neon-os-terrestrial-sampling-boundaries" class="level3">
<h3 class="anchored" data-anchor-id="neon-os-terrestrial-sampling-boundaries">2.2 NEON OS terrestrial sampling boundaries</h3>
<p>We will follow a similar process to download and visualize the NEON OS terrestrial sampling boundaries. The OS terrestrial sampling boundaries are also available as a shapefile, which can be downloaded from <a href="https://www.neonscience.org/data-samples/data/spatial-data-maps">NEON Spatial Data and Maps</a> page.</p>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and Unzip the NEON Terrestrial Field Sampling Boundaries Shapefile</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>neon_field_boundary_file <span class="op">=</span> <span class="st">"https://www.neonscience.org/sites/default/files/Field_Sampling_Boundaries_202503.zip"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use download_url function to save the file to the data directory</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>download_url(neon_field_boundary_file,<span class="st">'./data/shapefiles'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unzip the file</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ZipFile(<span class="ss">f"./data/shapefiles/Field_Sampling_Boundaries_202503.zip"</span>, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(<span class="st">'./data/shapefiles'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>neon_terr_bounds <span class="op">=</span> gpd.read_file(<span class="st">"./data/shapefiles/Field_Sampling_Boundaries/terrestrialSamplingBoundaries.shp"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>neon_terr_bounds.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save the boundaries for the site to a new variable called "site_terr_bounds"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>site_terr_bounds <span class="op">=</span> neon_terr_bounds[neon_terr_bounds.siteID <span class="op">==</span> site_id]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>site_terr_bounds.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="neon-is-tower-footprint-boundaries" class="level3">
<h3 class="anchored" data-anchor-id="neon-is-tower-footprint-boundaries">2.3 NEON IS tower footprint boundaries</h3>
<p>Lastly, we’ll download and read in the IS tower footprint shapefile, which represents the area of the airshed over which the IS tower collects data. This shapefile is available from the <a href="https://www.neonscience.org/data-samples/data/spatial-data-maps">NEON Spatial Data and Maps</a> page, but is pre-downloaded for convenience.</p>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># unzip the 90 percent footprint tower airshed file</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ZipFile(<span class="ss">f"./data/90percentfootprint.zip"</span>, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(<span class="st">'./data/shapefiles'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the neon tower airshed polygon shapefile and display</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>neon_tower_airshed <span class="op">=</span> gpd.read_file(<span class="st">"./data/shapefiles/90percentfootprint/90percent_footprint.shp"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>neon_tower_airshed.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save the boundaries for the site to a new variable called "site_terr_bounds"</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>site_tower_bounds <span class="op">=</span> neon_tower_airshed[neon_tower_airshed.SiteID <span class="op">==</span> site_id]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>site_tower_bounds.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-aop-os-and-is-boundaries-together" class="level3">
<h3 class="anchored" data-anchor-id="visualize-aop-os-and-is-boundaries-together">2.4 Visualize AOP, OS, and IS boundaries together</h3>
<p>Now that we’ve read in all the shapefiles into geodataframes, we can visualize them all together as follows. We will use the <code>plot_folium_shapes</code> function defined above, and define a <code>styles</code> list of dictionaries specifying the color, so that we can display each polygon with a different color.</p>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>neon_shapefiles <span class="op">=</span> [site_aop_polygon, site_terr_bounds, site_tower_bounds]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define a list of styles for the polygons</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># each style is a dictionary with 'fillColor' and 'color' keys</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>styles <span class="op">=</span> [</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'fillColor'</span>: <span class="st">'#228B22'</span>, <span class="st">'color'</span>: <span class="st">'#228B22'</span>}, <span class="co"># green</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'fillColor'</span>: <span class="st">'#00FFFFFF'</span>, <span class="st">'color'</span>: <span class="st">'#00FFFFFF'</span>}, <span class="co"># blue</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'fillColor'</span>: <span class="st">'#FF0000'</span>, <span class="st">'color'</span>: <span class="st">'#FF0000'</span>}, <span class="co"># red</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'fillColor'</span>: <span class="st">'#FFFF00'</span>, <span class="st">'color'</span>: <span class="st">'#FFFF00'</span>}, <span class="co"># yellow</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>map2 <span class="op">=</span> plot_folium_shapes(</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    shapefiles<span class="op">=</span>neon_shapefiles,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    names<span class="op">=</span>[<span class="st">'NEON AOP Flight Bounding Box'</span>, <span class="st">'NEON Terrestrial Sampling Boundaries'</span>, <span class="st">'NEON Tower Airshed'</span>],</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    styles<span class="op">=</span>styles</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>map2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<figure class="figure">
<a href="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/hyperspectral-classification/xarray/serc_aop_os_is_shapefiles.png"> <img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/hyperspectral-classification/xarray/serc_aop_os_is_shapefiles.png" alt="AOP SERC Flight Box" style="max-width: 100%; height: auto;" class="figure-img">
<figcaption>
AOP, OS, and IS polygons at the SERC site.
</figcaption>
</a>
</figure>
<p>Above we can see the SOAP flightbox, and the exterior TOS boundary polygon which shows the extent of the area where observational data are collected.</p>
</section>
</section>
<section id="find-available-neon-reflectance-data-and-download" class="level2">
<h2 class="anchored" data-anchor-id="find-available-neon-reflectance-data-and-download">3. Find available NEON reflectance data and download</h2>
<p>Finally we can look at the available NEON hyperspectral reflectance data, which are delivered as 1 km by 1 km hdf5 files (also called tiles) over the site. The next figure we make will make it clear why the files are called tiles. First, we will determine the available reflectance data, and then pull in some metadata shapefiles from another L3 AOP data product, derived from the lidar data.</p>
<p>NEON hyperspectral reflectance data are currently available under two different revisions, as AOP is in the process of implementing a BRDF (Bidirectional Reflectance Distribution Function), but this has not been applied to the full archive of data yet. These data product IDs are DP3.30006.001 (directional surface reflectance), and DP3.30006.002 (bidirectional surface reflectance). The bidirectional surface reflectance data include BRDF and topographic corrections, which helps correct for differences in illumination throughout the flight.</p>
<section id="find-available-data" class="level3">
<h3 class="anchored" data-anchor-id="find-available-data">3.1 Find available data</h3>
<p>Let’s see what data are available at the SERC site for each of these data products using the <code>neonutilities</code> <code>list_available_dates</code> function as follows:</p>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define the data product IDs for the reflectance data</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>refl_rev1_dpid <span class="op">=</span> <span class="st">'DP3.30006.001'</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>refl_rev2_dpid <span class="op">=</span> <span class="st">'DP3.30006.002'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Directional Reflectance Data Available at NEON Site </span><span class="sc">{</span>site_id<span class="sc">}</span><span class="ss">:'</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>nu.list_available_dates(refl_rev1_dpid,site_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Bidirectional Reflectance Data Available at NEON Site </span><span class="sc">{</span>site_id<span class="sc">}</span><span class="ss">:'</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>nu.list_available_dates(refl_rev2_dpid,site_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The dates provided are the year and month that the data were published (YYYY-MM). A single site may be collected over more than one month, so this publish date typically represents the month where the majority of the flight lines were collected. There are released directional reflectance data available from 2016 to 2021, and provisional bidirectional reflectance data available in 2022 and 2025. As of 2025, bidirectional data are only available provisionally because they were processed in 2024 (there is a year lag-time before data is released to allow for time to review for data quality issues).</p>
<p>For this exercise, we’ll look at the most recent data, from 2025. You may wish to consider other factors, for example if you collected field data in a certain year, you are looking at a year when there was a recent disturbance, or if you want to find the clearest weather data (data are not always collected in optimal sky conditions). For SERC, the most recent clear (&lt;10% cloud cover) weather collection to date was in 2017, so this directional reflectance data may be another good option to consider for your analysis.</p>
<p>For this lesson, we will use the 2025 bidirectional reflectance data, which is provisional.</p>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>year <span class="op">=</span> <span class="st">'2025'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-neon-lidar-data-using-neonutilities-by_file_aop" class="level3">
<h3 class="anchored" data-anchor-id="download-neon-lidar-data-using-neonutilities-by_file_aop">3.2 Download NEON Lidar data using neonutilities by_file_aop</h3>
<p>We can download the reflectance data either using the neonutilities function <code>nu.by_file_aop</code>, which downloads all tiles for the entire site for a given year, or <code>nu.by_tile_aop</code>. To figure out the inputs of these functions, you can type <code>nu.by_tile_aop?</code>, for example.</p>
<p>AOP data are projected into a WGS84 coordinate system, with coordinates in UTM x, y. When using <code>nu.by_tile_aop</code> you need to specify the UTM easting and northing values for the tiles you want to download. If you’re not sure the extent of the site, you can use the function <code>nu.get_aop_tile_extents</code>. Let’s do that here, for the SOAP site collected in 2024.You will use the same token you defined at the beginning of the tutorial</p>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>serc2025_utm_extents <span class="op">=</span> nu.get_aop_tile_extents(refl_rev2_dpid, </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                                               site_id,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                                               year,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                                               token<span class="op">=</span>NEON_TOKEN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The AOP collection over SERC in 2025 extends from UTM 358000 - 370000 m (Easting) and 4298000 - 4312000 m (Northing). To display a list of the extents of every tile, you can print <code>serc2025_utm_extents</code>. This is sometimes useful when trying to determine the extents of irregularly shaped sites.</p>
<p>We can also look at the full extents by downloading one of the smaller lidar raster data products to start. The L3 lidar data products include metadata shapefiles that can be useful for understanding the spatial extents of the individual files that comprise the data product. To show how to look at these shapefiles, we can download the Canopy Height Model data (DP3.30015.001). The next cell shows how to do this:</p>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download all CHM tiles (https://data.neonscience.org/data-products/DP3.30015.001)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>nu.by_file_aop(dpid<span class="op">=</span><span class="st">'DP3.30015.001'</span>, <span class="co"># Ecosystem Structure / CHM </span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>               site<span class="op">=</span>site_id,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>               year<span class="op">=</span>year,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>               include_provisional<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>               token<span class="op">=</span>NEON_TOKEN,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>               savepath<span class="op">=</span><span class="st">'./data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function below displays all of the folders that we’ve downloaded. You can also use your File Explorer to look at the contents of what you have downloaded.</p>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_data_subfolders(root_dir):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Recursively finds subfolders within a directory that contain data (files)</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and excludes subfolders that only contain other subfolders.</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">        root_dir: The path to the root directory to search.</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">        A list of paths to the subfolders containing data.</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    data_subfolders <span class="op">=</span> []</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(root_dir):</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if the current directory has both subdirectories and files</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dirs <span class="kw">and</span> files:</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Iterate through subdirectories to find those that contain files</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> dir_name <span class="kw">in</span> dirs:</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>                dir_path <span class="op">=</span> os.path.join(root, dir_name)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">any</span>(os.path.isfile(os.path.join(dir_path, f)) <span class="cf">for</span> f <span class="kw">in</span> os.listdir(dir_path)):</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>                    data_subfolders.append(dir_path)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the current directory has no subdirectories, but has files, we still want to keep the directory.</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> files:</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> root <span class="op">!=</span> root_dir:  <span class="co"># Avoid adding the root directory itself if it has files</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>                data_subfolders.append(root)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_subfolders</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use the find_data_subfolders function to see what has been downloaded</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>chm_subfolders <span class="op">=</span> find_data_subfolders(<span class="vs">r'</span><span class="dv">.</span><span class="vs">/data/DP3</span><span class="dv">.</span><span class="vs">30015</span><span class="dv">.</span><span class="vs">001'</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>chm_subfolders <span class="co"># display the subfolders</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see the path of the zip file that was downloaded (ends in .zip):</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(<span class="vs">r'</span><span class="dv">.</span><span class="vs">/data/DP3</span><span class="dv">.</span><span class="vs">30015</span><span class="dv">.</span><span class="vs">001'</span>):</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> files:</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name.endswith(<span class="st">'.zip'</span>):</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(os.path.join(root, name))  <span class="co"># print file name</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># unzip the lidar tile boundary file</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment if you skipped the download section, and comment the next line (starting with "with ZipFile")</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with ZipFile(f"./data/shapefiles/2025_SERC_7_TileBoundary.zip", 'r') as zip_ref: </span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ZipFile(<span class="ss">f"./data/DP3.30015.001/neon-aop-provisional-products/2025/FullSite/D02/2025_SERC_7/Metadata/DiscreteLidar/TileBoundary/2025_SERC_7_TileBoundary.zip"</span>,<span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(<span class="st">'./data/shapefiles/2025_SERC_7_TileBoundary'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the tile bounadry shapefile</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>aop_tile_boundaries <span class="op">=</span> gpd.read_file(<span class="st">"./data/shapefiles/2025_SERC_7_TileBoundary/shps/NEON_D02_SERC_DPQA_2025_merged_tiles_boundary.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># append this last boundary file to the existing neon_shapefiles list</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>neon_shapefiles.append(aop_tile_boundaries)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot all NEON SERC shapefiles together</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>map3 <span class="op">=</span> plot_folium_shapes(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    shapefiles<span class="op">=</span>neon_shapefiles,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    names<span class="op">=</span>[<span class="st">'NEON AOP Flight Bounding Box'</span>, <span class="st">'NEON Terrestrial Sampling Boundaries'</span>, <span class="st">'NEON Tower Airshed'</span>, <span class="st">'AOP Tile Boundaries'</span>],</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    styles<span class="op">=</span>styles,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    zoom_start<span class="op">=</span><span class="dv">12</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>map3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<figure class="figure">
<a href="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/hyperspectral-classification/xarray/serc_aop_tiles.png"> <img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/hyperspectral-classification/xarray/serc_aop_tiles.png" alt="AOP SERC Flight Box" style="max-width: 100%; height: auto;" class="figure-img">
<figcaption>
AOP, OS, and IS polygons at the SERC site.
</figcaption>
</a>
</figure>
<p>From the image above, you can see why the data are called “tiles”! The individual tiles make up a grid comprising the full site. These smaller areas make it easier to process the large data, and allow for batch processing instead of running an operation on a huge file, which might cause memory errors.</p>
</section>
<section id="download-neon-reflectance-data-using-neonutilities-by_tile_aop" class="level3">
<h3 class="anchored" data-anchor-id="download-neon-reflectance-data-using-neonutilities-by_tile_aop">3.3 Download NEON Reflectance Data using neonutilities by_tile_aop</h3>
<p>Now that we’ve explored the spatial extent of the NEON airborne data, as well as the OS terrestrial sampling plots and the IS tower airshed, we can start playing with the data! First, let’s download a single tile to start. For this exercise we’ll download the tile that encompasses the NEON tower, since there is typically more OS sampling in the NEON tower plots. The tile of interest for us is <code>365000_4305000</code> (note that AOP tiles are named by the SW or lower-left coordinate of the tile).</p>
<p>You can specify the download path using the <code>savepath</code> variable. Let’s set it to a data directory in line with the root directory where we’re working, in this case we’ll set it to <code>./data/NEON/refl</code>.</p>
<p>The reflectance data are large in size (especially for an entire site’s worth of data), so by default the download functions will display the expected download size and ask if you want to proceed with the download (y/n). The reflectance tile downloaded below is ~ 660 MB in size, so make sure you have enough space on your local disk (or cloud platform) before downloading. If you want to download without being prompted to continue, you can set the input variable <code>check_size=False</code>.</p>
<p>By default the files will be downloaded following the same structure that they are stored in on Google Cloud Storage, so the actual data files are nested in sub-folders. We encourage you to navigate through the <code>data/DP3.30006.002</code> folder, and explore the additional metadata (such as QA reports) that are downloaded along with the data.</p>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download the tile that encompasses the NEON tower</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>nu.by_tile_aop(dpid<span class="op">=</span><span class="st">'DP3.30006.002'</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>               site<span class="op">=</span>site_id,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>               year<span class="op">=</span><span class="dv">2025</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>               easting<span class="op">=</span><span class="dv">364005</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>               northing<span class="op">=</span><span class="dv">4305005</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>               include_provisional<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>               token<span class="op">=</span>NEON_TOKEN,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>               savepath<span class="op">=</span><span class="st">'./data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can either navigate to the download folder in File Explorer, or to programmatically see what files were downloaded, you can display the files as follows:</p>
<div id="cell-52" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see all files that were downloaded (including data, metadata, and READMEs):</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(<span class="vs">r'</span><span class="dv">.</span><span class="vs">/data/DP3</span><span class="dv">.</span><span class="vs">30006</span><span class="dv">.</span><span class="vs">002'</span>):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> files:</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(os.path.join(root, name))  <span class="co"># print file name</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can see there are several .txt and .csv files in addition to the .h5 data file (NEON_D02_SERC_DP3_364000_4305000_bidirectional_reflectance.h5). These include citation information: <code>citation_DP3.30006.002_PROVISIONAL.txt</code>, an issue log: <code>issueLog_DP3.30006.002.csv</code>, and a README: <code>NEON.D02.SERC.DP3.30006.002.readme.20250719T050120Z.txt</code>. We encourage you to look through these files, particularly the issue log, which conveys information about issues and the resolution for the data product in question. Make sure there is not a known issue with the data you downloaded, especially since it is provisional.</p>
<p>If you only want to see the names of the .h5 reflectance data you downloaded, you can modify the code as follows:</p>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see only the .h5 files that were downloaded</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(<span class="vs">r'</span><span class="dv">.</span><span class="vs">/data/DP3</span><span class="dv">.</span><span class="vs">30006</span><span class="dv">.</span><span class="vs">002'</span>):</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> files:</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name.endswith(<span class="st">'.h5'</span>):</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(os.path.join(root, name))  <span class="co"># print file name</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Success! We’ve now downloaded a NEON bidirectional surface reflectance tile into our data directory.</p>
</section>
</section>
<section id="read-in-and-visualize-reflectance-data-interactively" class="level2">
<h2 class="anchored" data-anchor-id="read-in-and-visualize-reflectance-data-interactively">4. Read in and visualize reflectance data interactively</h2>
<section id="convert-reflectance-data-to-an-xarray-dataset" class="level3">
<h3 class="anchored" data-anchor-id="convert-reflectance-data-to-an-xarray-dataset">4.1 Convert Reflectance Data to an xarray Dataset</h3>
<p>The function below will read in a NEON reflectance hdf5 dataset and export an xarray dataset. According to the <code>xarray</code> documentation, “xarray makes working with labelled multi-dimensional arrays in Python simple, efficient, and fun!” <code>rioxarray</code> is simply the rasterio xarray extension, so you can work with xarray for geospatial data.</p>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> aop_h5refl2xarray(h5_filename):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Reads a NEON AOP reflectance HDF5 file and returns an xarray.Dataset with reflectance and weather quality indicator data.</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">    h5_filename : str</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to the NEON AOP reflectance HDF5 file.</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">    dsT : xarray.Dataset</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co">        An xarray Dataset containing:</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="co">            - 'reflectance': DataArray of reflectance values (y, x, wavelengths)</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="co">            - 'weather_quality_indicator': DataArray of weather quality indicator (y, x)</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co">            - Coordinates: y (UTM northing), x (UTM easting), wavelengths, fwhm, good_wavelengths</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="co">            - Metadata attributes: projection, spatial_ref, EPSG, no_data_value, scale_factor, bad_band_window1, bad_band_window2, etc.</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> h5py</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> h5py.File(h5_filename) <span class="im">as</span> hdf5_file:</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Reading in '</span>, h5_filename)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        sitename <span class="op">=</span> <span class="bu">list</span>(hdf5_file.keys())[<span class="dv">0</span>]</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        h5_refl_group <span class="op">=</span> hdf5_file[sitename][<span class="st">'Reflectance'</span>]</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>        refl_dataset <span class="op">=</span> h5_refl_group[<span class="st">'Reflectance_Data'</span>]</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        refl_array <span class="op">=</span> refl_dataset[()].astype(<span class="st">'float32'</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transpose and flip reflectance data</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        refl_arrayT <span class="op">=</span> np.transpose(refl_array, (<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">2</span>))</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        refl_arrayT <span class="op">=</span> refl_array[::<span class="op">-</span><span class="dv">1</span>, :, :]</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>        refl_shape <span class="op">=</span> refl_arrayT.shape</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        wavelengths <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Spectral_Data'</span>][<span class="st">'Wavelength'</span>][:]</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        fwhm <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Spectral_Data'</span>][<span class="st">'FWHM'</span>][:]</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Weather Quality Indicator: transpose and flip to match reflectance</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        wqi_array <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Ancillary_Imagery'</span>][<span class="st">'Weather_Quality_Indicator'</span>][()]</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        wqi_arrayT <span class="op">=</span> np.transpose(wqi_array, (<span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        wqi_arrayT <span class="op">=</span> wqi_array[::<span class="op">-</span><span class="dv">1</span>, :]</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collect metadata</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> {}</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'shape'</span>] <span class="op">=</span> refl_shape</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'no_data_value'</span>] <span class="op">=</span> <span class="bu">float</span>(refl_dataset.attrs[<span class="st">'Data_Ignore_Value'</span>])</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'scale_factor'</span>] <span class="op">=</span> <span class="bu">float</span>(refl_dataset.attrs[<span class="st">'Scale_Factor'</span>])</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'bad_band_window1'</span>] <span class="op">=</span> h5_refl_group.attrs[<span class="st">'Band_Window_1_Nanometers'</span>]</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'bad_band_window2'</span>] <span class="op">=</span> h5_refl_group.attrs[<span class="st">'Band_Window_2_Nanometers'</span>]</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'projection'</span>] <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Coordinate_System'</span>][<span class="st">'Proj4'</span>][()].decode(<span class="st">'utf-8'</span>)</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'spatial_ref'</span>] <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Coordinate_System'</span>][<span class="st">'Coordinate_System_String'</span>][()].decode(<span class="st">'utf-8'</span>)</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'EPSG'</span>] <span class="op">=</span> <span class="bu">int</span>(h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Coordinate_System'</span>][<span class="st">'EPSG Code'</span>][()])</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse map info for georeferencing</span></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>        map_info <span class="op">=</span> <span class="bu">str</span>(h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Coordinate_System'</span>][<span class="st">'Map_Info'</span>][()]).split(<span class="st">","</span>)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>        pixel_width <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">5</span>])</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        pixel_height <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">6</span>])</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>        x_min <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">3</span>])<span class="op">;</span> x_min <span class="op">=</span> <span class="bu">int</span>(x_min)</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>        y_max <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">4</span>])<span class="op">;</span> y_max <span class="op">=</span> <span class="bu">int</span>(y_max)</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>        x_max <span class="op">=</span> x_min <span class="op">+</span> (refl_shape[<span class="dv">1</span>]<span class="op">*</span>pixel_width)<span class="op">;</span> x_max <span class="op">=</span> <span class="bu">int</span>(x_max)</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>        y_min <span class="op">=</span> y_max <span class="op">-</span> (refl_shape[<span class="dv">0</span>]<span class="op">*</span>pixel_height)<span class="op">;</span> y_min <span class="op">=</span> <span class="bu">int</span>(y_min)</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate UTM coordinates for x and y axes</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>        x_coords <span class="op">=</span> np.linspace(x_min, x_max, num<span class="op">=</span>refl_shape[<span class="dv">1</span>]).astype(<span class="bu">float</span>)</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>        y_coordsT <span class="op">=</span> np.linspace(y_min, y_max, num<span class="op">=</span>refl_shape[<span class="dv">0</span>]).astype(<span class="bu">float</span>)</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Flag good/bad wavelengths (1=good, 0=bad)</span></span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        good_wavelengths <span class="op">=</span> np.ones_like(wavelengths)</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bad_window <span class="kw">in</span> [metadata[<span class="st">'bad_band_window1'</span>], metadata[<span class="st">'bad_band_window2'</span>]]:</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>            bad_indices <span class="op">=</span> np.where((wavelengths <span class="op">&gt;=</span> bad_window[<span class="dv">0</span>]) <span class="op">&amp;</span> (wavelengths <span class="op">&lt;=</span> bad_window[<span class="dv">1</span>]))[<span class="dv">0</span>]</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>            good_wavelengths[bad_indices] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>        good_wavelengths[<span class="op">-</span><span class="dv">10</span>:] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create xarray DataArray for reflectance</span></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>        refl_xrT <span class="op">=</span> xr.DataArray(</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>            refl_arrayT,</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>            dims<span class="op">=</span>[<span class="st">"y"</span>, <span class="st">"x"</span>, <span class="st">"wavelengths"</span>],</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"reflectance"</span>,</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>            coords<span class="op">=</span>{</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>                <span class="st">"y"</span>: (<span class="st">"y"</span>, y_coordsT),</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>                <span class="st">"x"</span>: (<span class="st">"x"</span>, x_coords),</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>                <span class="st">"wavelengths"</span>: (<span class="st">"wavelengths"</span>, wavelengths),</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fwhm"</span>: (<span class="st">"wavelengths"</span>, fwhm),</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>                <span class="st">"good_wavelengths"</span>: (<span class="st">"wavelengths"</span>, good_wavelengths)</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create xarray DataArray for Weather Quality Indicator</span></span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>        wqi_xrT <span class="op">=</span> xr.DataArray(</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>            wqi_arrayT,</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>            dims<span class="op">=</span>[<span class="st">"y"</span>, <span class="st">"x"</span>],</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"weather_quality_indicator"</span>,</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>            coords<span class="op">=</span>{</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>                <span class="st">"y"</span>: (<span class="st">"y"</span>, y_coordsT),</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>                <span class="st">"x"</span>: (<span class="st">"x"</span>, x_coords)</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create xarray Dataset and add metadata as attributes</span></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>        dsT <span class="op">=</span> xr.Dataset({</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">"reflectance"</span>: refl_xrT,</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">"weather_quality_indicator"</span>: wqi_xrT</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> metadata.items():</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'shape'</span>, <span class="st">'extent'</span>, <span class="st">'ext_dict'</span>]:</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>                dsT.attrs[key] <span class="op">=</span> value</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dsT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we’ve defined a function that reads in the reflectance hdf5 data and exports an xarray dataset, we can apply this function to our downloaded reflectance data. This should take around 15 seconds or so to run.</p>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment the line below and comment the following one if running from the Openscapes platform and you skipped the download step</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># serc_refl_h5 = serc_refl_h5 = r'../../shared-public/data/neon/NEON_D02_SERC_DP3_364000_4305000_bidirectional_reflectance.h5'</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>serc_refl_h5 <span class="op">=</span> <span class="vs">r'</span><span class="dv">.</span><span class="vs">/data/DP3</span><span class="dv">.</span><span class="vs">30006</span><span class="dv">.</span><span class="vs">002/neon-aop-provisional-products/2025/FullSite/D02/2025_SERC_7/L3/Spectrometer/Reflectance/NEON_D02_SERC_DP3_364000_4305000_bidirectional_reflectance</span><span class="dv">.</span><span class="vs">h5'</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>serc_refl_xr <span class="op">=</span> aop_h5refl2xarray(serc_refl_h5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next let’s define a function that updates the neon reflectance xarray dataset to apply the no data value (-9999), set the bad bands to NaN, and applies the CRS to make the xarray objet an rioxarray object. These could also be incorporated into the function above, but you may wish to work with unscaled reflectance data, for example, so we will keep these functions separate for now.</p>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_neon_xr(neon_refl_ds):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set no data values (-9999) equal to np.nan</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    neon_refl_ds.reflectance.data[neon_refl_ds.reflectance.data <span class="op">==</span> <span class="op">-</span><span class="dv">9999</span>] <span class="op">=</span> np.nan</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale by the reflectance scale factor</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    neon_refl_ds[<span class="st">'reflectance'</span>].data <span class="op">=</span> ((neon_refl_ds[<span class="st">'reflectance'</span>].data) <span class="op">/</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                                        (neon_refl_ds.attrs[<span class="st">'scale_factor'</span>]))</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set "bad bands" (water vapor absorption bands and noisy bands) to NaN</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    neon_refl_ds[<span class="st">'reflectance'</span>].data[:,:,neon_refl_ds[<span class="st">'good_wavelengths'</span>].data<span class="op">==</span><span class="fl">0.0</span>] <span class="op">=</span> np.nan</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    neon_refl_ds.rio.write_crs(<span class="ss">f"epsg:</span><span class="sc">{</span>neon_refl_ds<span class="sc">.</span>attrs[<span class="st">'EPSG'</span>]<span class="sc">}</span><span class="ss">"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> neon_refl_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Apply this function on our xarray dataset.</p>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>serc_refl_xr <span class="op">=</span> update_neon_xr(serc_refl_xr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-the-reflectance-dataset" class="level3">
<h3 class="anchored" data-anchor-id="visualize-the-reflectance-dataset">4.2 Visualize the reflectance dataset</h3>
<p>Display the dataset. You can use the up and down arrows to the left of the table (e.g.&nbsp;to the left of Dimensions, Coordinates, Data variables, etc.) to explore each part of the dataset in more detail. You can also click on the icons to the right to see more details.</p>
<div id="cell-64" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>serc_refl_xr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to auto-scale to make RGB images more realistic</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gamma_adjust(rgb_ds, bright<span class="op">=</span><span class="fl">0.2</span>, white_background<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    array <span class="op">=</span> rgb_ds.reflectance.data</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> math.log(bright)<span class="op">/</span>math.log(np.nanmean(array)) <span class="co"># Create exponent for gamma scaling - can be adjusted by changing 0.2 </span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    scaled <span class="op">=</span> np.power(np.nan_to_num(array,nan<span class="op">=</span><span class="dv">1</span>),np.nan_to_num(gamma,nan<span class="op">=</span><span class="dv">1</span>)).clip(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Apply scaling and clip to 0-1 range</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> white_background <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        scaled <span class="op">=</span> np.nan_to_num(scaled, nan <span class="op">=</span> <span class="dv">1</span>) <span class="co"># Set NANs to 1 so they appear white in plots</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    rgb_ds.reflectance.data <span class="op">=</span> scaled</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rgb_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-the-reflectance-dataset" class="level3">
<h3 class="anchored" data-anchor-id="plot-the-reflectance-dataset">4.3 Plot the reflectance dataset</h3>
<p>Now let’s plot a true color (or RGB) image of the reflectance data as shown in the cell below.</p>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the RGB image of the SERC tower tile</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>serc_refl_rgb <span class="op">=</span> serc_refl_xr.sel(wavelengths<span class="op">=</span>[<span class="dv">650</span>, <span class="dv">560</span>, <span class="dv">470</span>], method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>serc_refl_rgb <span class="op">=</span> gamma_adjust(serc_refl_rgb,bright<span class="op">=</span><span class="fl">0.3</span>,white_background<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>serc_rgb_plot <span class="op">=</span> serc_refl_rgb.hvplot.rgb(y<span class="op">=</span><span class="st">'y'</span>,x<span class="op">=</span><span class="st">'x'</span>,bands<span class="op">=</span><span class="st">'wavelengths'</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>                         xlabel<span class="op">=</span><span class="st">'UTM x'</span>,ylabel<span class="op">=</span><span class="st">'UTM y'</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>                         title<span class="op">=</span><span class="st">'NEON AOP Reflectance RGB - SERC Tower Tile'</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>                         frame_width<span class="op">=</span><span class="dv">480</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set axis format to integer (no scientific notation)</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>serc_rgb_plot <span class="op">=</span> serc_rgb_plot.opts(</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    xformatter<span class="op">=</span><span class="st">'%.0f'</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    yformatter<span class="op">=</span><span class="st">'%.0f'</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>serc_rgb_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-the-weather-quality-indicator-data" class="level3">
<h3 class="anchored" data-anchor-id="plot-the-weather-quality-indicator-data">4.4 Plot the weather quality indicator data</h3>
<p>We can look at the weather conditions during the flight by displaying the <code>weather_quality_indicator</code> data array. This is a 2D array with values ranging from 1 to 3, where: 1 = &lt;10% cloud cover, 2 = 10-50% cloud cover, 3 = &gt;50% cloud cover. NEON uses a stop-light convention to indicate the weather and cloud conditions, where green (1) is good, yellow (2) is moderate, and red (3) is poor. The figure below shows some examples of these three conditions as captured by the flight operators during science flights.</p>
<figure class="figure">
<a href="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/aop-gee2023/1b_sdr_weather/flight_cloud_photos.png"> <img src="https://raw.githubusercontent.com/NEONScience/NEON-Data-Skills/main/graphics/aop-gee2023/1b_sdr_weather/flight_cloud_photos.png" alt="In-flight cloud photos" style="max-width: 100%; height: auto;" class="figure-img">
<figcaption>
Cloud cover percentage during AOP flights. Left: green (&lt;10%), Middle: yellow (10-50%), Right: red (&gt;50%).
</figcaption>
</a>
</figure>
<p>Let’s visualize this weather quality indicator data for this SERC tile using a transparent color on top of our RGB reflectance plot, following the same stop-light convention.</p>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the WQI mask</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>wqi <span class="op">=</span> serc_refl_xr.weather_quality_indicator</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Map WQI values to colors: 1=green, 2=yellow, 3=red, 0/other=transparent</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>wqi_colors <span class="op">=</span> [<span class="st">'#228B22'</span>, <span class="st">'#FFFF00'</span>, <span class="st">'#FF0000'</span>]</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># wqi_mask = wqi[wqi &gt; 0]  # mask out zeros or nodata</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use hvplot with categorical colormap and alpha (50% transparency)</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>wqi_overlay <span class="op">=</span> wqi.hvplot.image(</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'x'</span>, y<span class="op">=</span><span class="st">'y'</span>, cmap<span class="op">=</span>wqi_colors,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    clim<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">3</span>), colorbar<span class="op">=</span><span class="va">False</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">'UTM x'</span>, ylabel<span class="op">=</span><span class="st">'UTM y'</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'NEON AOP Reflectance Weather Quality - SERC Tower Tile'</span>,</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    frame_width<span class="op">=</span><span class="dv">480</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay the RGB and WQI</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>(serc_rgb_plot <span class="op">*</span> wqi_overlay).opts(title<span class="op">=</span><span class="st">"RGB + Weather Quality Indicator"</span>).opts(xformatter<span class="op">=</span><span class="st">'%.0f'</span>,</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>                                                                                 yformatter<span class="op">=</span><span class="st">'%.0f'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The cloud conditions for this tile are yellow, which indicates somewhere between 10-50% cloud cover, which is moderate. This is not ideal for reflectance data, but it is still usable. As we will use this data for classification, you would want to consider how the cloud cover may impact your results. You may wish to find a clear-weather (&lt;10% cloud cover) tile to run classification, or at a minimum compare results between the two to better understand how cloud cover impacts the model.</p>
</section>
<section id="plot-a-false-color-image" class="level3">
<h3 class="anchored" data-anchor-id="plot-a-false-color-image">4.5 Plot a false color image</h3>
<p>Let’s continue visualizing the data, next by making a False-Color image, which is a 3-band combination that shows you more than what you would see with the naked eye. For example, you can pull in SWIR or NIR bands to create an image that shows more information about vegetation health Here we will use a SWIR band (2000 nm), a NIR band (850 nm), and blue band (450 nm). Try some different band combinations on your own, remembering not to use bands that are flagged as bad (e.g.&nbsp;the last 10 bands, or those in the bad band windows between 1340-1445 nm and between 1790-1955 nm).</p>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a False-Color image of the SERC tower tile</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>serc_refl_false_color <span class="op">=</span> serc_refl_xr.sel(wavelengths<span class="op">=</span>[<span class="dv">2000</span>, <span class="dv">850</span>, <span class="dv">450</span>], method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>serc_refl_false_color <span class="op">=</span> gamma_adjust(serc_refl_false_color,bright<span class="op">=</span><span class="fl">0.3</span>,white_background<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>serc_refl_false_color.hvplot.rgb(y<span class="op">=</span><span class="st">'y'</span>,x<span class="op">=</span><span class="st">'x'</span>,bands<span class="op">=</span><span class="st">'wavelengths'</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                         xlabel<span class="op">=</span><span class="st">'UTM x'</span>,ylabel<span class="op">=</span><span class="st">'UTM y'</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                         title<span class="op">=</span><span class="st">'NEON AOP Reflectance False Color Image - SERC Tower Tile'</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>                         frame_width<span class="op">=</span><span class="dv">480</span>, frame_height<span class="op">=</span><span class="dv">480</span>).opts(xformatter<span class="op">=</span><span class="st">'%.0f'</span>, yformatter<span class="op">=</span><span class="st">'%.0f'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-an-interactive-spectral-signature-plot" class="level3">
<h3 class="anchored" data-anchor-id="make-an-interactive-spectral-signature-plot">4.6 Make an interactive spectral signature plot</h3>
<p>We can also make an interactive plot that displays the spectral signature of the reflectance data for any pixel you click on. This is useful for exploring the spectral signature of different land cover types, and can help you identify which bands may be most useful for classification.</p>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Interactive Points Plotting</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modified from https://github.com/auspatious/hyperspectral-notebooks/blob/main/03_EMIT_Interactive_Points.ipynb</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>POINT_LIMIT <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>color_cycle <span class="op">=</span> hv.Cycle(<span class="st">'Category20'</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create RGB Map</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span> <span class="op">=</span> serc_refl_rgb.hvplot.rgb(x<span class="op">=</span><span class="st">'x'</span>, y<span class="op">=</span><span class="st">'y'</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                               bands<span class="op">=</span><span class="st">'wavelengths'</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                               fontscale<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                               xlabel<span class="op">=</span><span class="st">'UTM x'</span>, ylabel<span class="op">=</span><span class="st">'UTM y'</span>,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                               frame_width<span class="op">=</span><span class="dv">480</span>, frame_height<span class="op">=</span><span class="dv">480</span>).opts(xformatter<span class="op">=</span><span class="st">'%.0f'</span>, yformatter<span class="op">=</span><span class="st">'%.0f'</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a holoviews points array to enable plotting of the clicked points</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>xmid <span class="op">=</span> serc_refl_rgb.x.values[<span class="bu">int</span>(<span class="bu">len</span>(serc_refl_rgb.x) <span class="op">/</span> <span class="dv">2</span>)]</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>ymid <span class="op">=</span> serc_refl_rgb.y.values[<span class="bu">int</span>(<span class="bu">len</span>(serc_refl_rgb.y) <span class="op">/</span> <span class="dv">2</span>)]</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> serc_refl_rgb.x.values[<span class="dv">0</span>]</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>y0 <span class="op">=</span> serc_refl_rgb.y.values[<span class="dv">0</span>]</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="co"># first_point = ([xmid], [ymid], [0])</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>first_point <span class="op">=</span> ([x0], [y0], [<span class="dv">0</span>])</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> hv.Points(first_point, vdims<span class="op">=</span><span class="st">'id'</span>)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>points_stream <span class="op">=</span> hv.streams.PointDraw(</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>points.columns(),</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>points,</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    drag<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    num_objects<span class="op">=</span>POINT_LIMIT,</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    styles<span class="op">=</span>{<span class="st">'fill_color'</span>: color_cycle.values[<span class="dv">1</span>:POINT_LIMIT<span class="op">+</span><span class="dv">1</span>], <span class="st">'line_color'</span>: <span class="st">'gray'</span>}</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>posxy <span class="op">=</span> hv.streams.PointerXY(source<span class="op">=</span><span class="bu">map</span>, x<span class="op">=</span>xmid, y<span class="op">=</span>ymid)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>clickxy <span class="op">=</span> hv.streams.Tap(source<span class="op">=</span><span class="bu">map</span>, x<span class="op">=</span>xmid, y<span class="op">=</span>ymid)</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to build spectral plot of clicked location to show on hover stream plot</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> click_spectra(data):</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    coordinates <span class="op">=</span> []</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="kw">not</span> <span class="bu">any</span>(<span class="bu">len</span>(d) <span class="cf">for</span> d <span class="kw">in</span> data.values()):</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>        coordinates.append(clicked_points[<span class="dv">0</span>][<span class="dv">0</span>], clicked_points[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>        coordinates <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">zip</span>(data[<span class="st">'x'</span>], data[<span class="st">'y'</span>])]</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>    plots <span class="op">=</span> []</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, coords <span class="kw">in</span> <span class="bu">enumerate</span>(coordinates):</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> coords</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> serc_refl_xr.sel(x<span class="op">=</span>x, y<span class="op">=</span>y, method<span class="op">=</span><span class="st">"nearest"</span>)</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>        plots.append(</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>            data.hvplot.line(</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>                y<span class="op">=</span><span class="st">"reflectance"</span>,</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span><span class="st">"wavelengths"</span>,</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color_cycle,</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>        points_stream.data[<span class="st">"id"</span>][i] <span class="op">=</span> i</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hv.Overlay(plots)</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hover_spectra(x,y):</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> serc_refl_xr.sel(x<span class="op">=</span>x,y<span class="op">=</span>y,method<span class="op">=</span><span class="st">'nearest'</span>).hvplot.line(y<span class="op">=</span><span class="st">'reflectance'</span>,x<span class="op">=</span><span class="st">'wavelengths'</span>, color<span class="op">=</span><span class="st">'black'</span>, frame_width<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return emit_ds.sel(longitude=x,latitude=y,method='nearest').hvplot.line(y='reflectance',x='wavelengths',</span></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                                                         color='black', frame_width=400)</span></span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Dynamic Maps</span></span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>click_dmap <span class="op">=</span> hv.DynamicMap(click_spectra, streams<span class="op">=</span>[points_stream])</span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>hover_dmap <span class="op">=</span> hv.DynamicMap(hover_spectra, streams<span class="op">=</span>[posxy])</span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the Map and Dynamic Map side by side</span></span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>hv.Layout(hover_dmap<span class="op">*</span>click_dmap <span class="op">+</span> <span class="bu">map</span> <span class="op">*</span> points).cols(<span class="dv">2</span>).opts(</span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>    hv.opts.Points(active_tools<span class="op">=</span>[<span class="st">'point_draw'</span>], size<span class="op">=</span><span class="dv">10</span>, tools<span class="op">=</span>[<span class="st">'hover'</span>], color<span class="op">=</span><span class="st">'white'</span>, line_color<span class="op">=</span><span class="st">'gray'</span>),</span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>    hv.opts.Overlay(show_legend<span class="op">=</span><span class="va">False</span>, show_title<span class="op">=</span><span class="va">False</span>, fontscale<span class="op">=</span><span class="fl">1.5</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="supervised-classification-using-tos-vegetation-structure-data" class="level2">
<h2 class="anchored" data-anchor-id="supervised-classification-using-tos-vegetation-structure-data">5. Supervised Classification Using TOS Vegetation Structure Data</h2>
<p>In the last part of this lesson, we’ll go over an example of how to run a supervised classification using the reflectance data along with observational “vegetation structure” data. We will create a random forest model to classify the families of trees represented in this SERC tile, using species determined from the vegetation structure data product <a href="https://data.neonscience.org/data-products/DP1.10098.001" target="_blank">DP1.10098.001</a>. See the notebook <a href="https://www.neonscience.org/resources/learning-hub/tutorials/classification-training-data" target="_blank">Make Training Data for Species Modeling from NEON TOS Vegetation Structure Dat</a> to learn how the vegetation structure data were pre-processed to generate the training data file. In this notebook, we will just read in this file as a starting point.</p>
<p>Note that this is a quick-and-dirty example, and there are many ways you could improve the classification results, such as using more training data (this uses only data within this AOP tile), filtering out sub-optimal data (e.g.&nbsp;data collected in &gt; 10 % cloud cover conditions, removing outliers (e.g.&nbsp;due to geospatial mis-match, shadowing, or other issues), tuning the model parameters, or using a different classification algorithm.</p>
<p>Let’s get started, first by exploring the training data.</p>
<section id="read-in-the-training-data" class="level3">
<h3 class="anchored" data-anchor-id="read-in-the-training-data">5.1 Read in the training data</h3>
<p>First, read in the training data csv file (called <code>serc_2025_training_data.csv</code>) that was generated in the previous lesson. This file contains the training data for the random forest model, including the taxonId, family, and geographic coordinates (UTM easting and northing) of the training points. Note that there was not a lot of extensive pre-processing when creating this training data, so you may want to consider ways to assess and improve the training data quality before running the model.</p>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>woody_veg_data <span class="op">=</span> pd.read_csv(<span class="vs">r"</span><span class="dv">.</span><span class="vs">/data/serc_training_data</span><span class="dv">.</span><span class="vs">csv"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>woody_veg_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the <code>xarray</code> <code>sel</code> method to select the reflectance data corresponding to the training points. This will return an xarray dataset with the reflectance values for each band at the training point locations. As a test, let’s plot the reflectance values for the first training point, which corresponds to an American Beech tree (Fagaceae family).</p>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the coordinates of the first training data pixel</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>easting <span class="op">=</span> woody_veg_data.iloc[<span class="dv">0</span>][<span class="st">'adjEasting'</span>]</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>northing <span class="op">=</span> woody_veg_data.iloc[<span class="dv">0</span>][<span class="st">'adjNorthing'</span>]</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the reflectance data from serc_refl_xr for the specified coordinates</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>pixel_value <span class="op">=</span> serc_refl_xr.sel(x<span class="op">=</span>easting, y<span class="op">=</span>northing, method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>pixel_value.reflectance</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the reflectance values for the pixel</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>plt.plot(pixel_value[<span class="st">'wavelengths'</span>].values.flatten(), pixel_value[<span class="st">'reflectance'</span>].values.flatten(), <span class="st">'o'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As another test, we can plot the refletance value for one of the water bodies that shows up in the reflectance data. In the interactive plot, hover your mouse over one of the water bodies to see the UTM x, y coordinates, and then set those as the easting and northing, as shown below.</p>
<div id="cell-79" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the coordinates of the pixel over the pool in the NW corner of the site</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>easting <span class="op">=</span> <span class="dv">364750</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>northing <span class="op">=</span> <span class="dv">4305180</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract and plot the reflectance data from serc_refl_xr specified coordinates</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>pixel_value <span class="op">=</span> serc_refl_xr.sel(x<span class="op">=</span>easting, y<span class="op">=</span>northing, method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>plt.plot(pixel_value[<span class="st">'wavelengths'</span>].values.flatten(), pixel_value[<span class="st">'reflectance'</span>].values.flatten(), <span class="st">'o'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can see that the spectral signature of water is quite different from that of vegetation.</p>
<p>Now that we’ve extracted the pixel value for a single pixel, we can extract the reflectance values for all of the training data points. We will loop through the rows of the training dataframe and use the <code>xarray.Dataset.sel</code> method to select the reflectance values of the pixels corresponding to the same geographic location as the training data points, and then we will convert this into a pandas DataFrame for use in the random forest model.</p>
</section>
<section id="inspect-the-training-data" class="level3">
<h3 class="anchored" data-anchor-id="inspect-the-training-data">5.2 Inspect the training data</h3>
<p>It is good practice to visually inspect the spectral signatures of the training data, for example, as shown above, to make sure you are executing the code correctly, and that there aren’t any major outliers (e.g.&nbsp;you might catch instances of geographic mismatch between the terrestrial location and the airborne data, or if there was a shadowing effect that caused the reflectance values to be very low).</p>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the wavelengths as column names for reflectance</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>wavelengths <span class="op">=</span> serc_refl_xr.wavelengths.values</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>wavelength_cols <span class="op">=</span> [<span class="ss">f'refl_</span><span class="sc">{</span><span class="bu">int</span>(wl)<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> wl <span class="kw">in</span> wavelengths]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> []</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> woody_veg_data.iterrows():</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find nearest pixel in xarray</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    y_val <span class="op">=</span> serc_refl_xr.y.sel(y<span class="op">=</span>row[<span class="st">'adjNorthing'</span>], method<span class="op">=</span><span class="st">'nearest'</span>).item()</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    x_val <span class="op">=</span> serc_refl_xr.x.sel(x<span class="op">=</span>row[<span class="st">'adjEasting'</span>], method<span class="op">=</span><span class="st">'nearest'</span>).item()</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract reflectance spectrum</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    refl <span class="op">=</span> serc_refl_xr.reflectance.sel(y<span class="op">=</span>y_val, x<span class="op">=</span>x_val).values</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build record: taxonID, easting, northing, reflectance values</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    record <span class="op">=</span> {</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'taxonID'</span>: row[<span class="st">'taxonID'</span>],</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'family'</span>: row[<span class="st">'family'</span>],</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'adjEasting'</span>: row[<span class="st">'adjEasting'</span>],</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'adjNorthing'</span>: row[<span class="st">'adjNorthing'</span>],</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add reflectance values with wavelength column names</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    record.update({col: val <span class="cf">for</span> col, val <span class="kw">in</span> <span class="bu">zip</span>(wavelength_cols, refl)})</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    records.append(record)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now create a dataframe from these records, and display. You can see that the reflectance values are in columns named <code>refl_381</code>, <code>refl_386</code>, etc., and the family is in the <code>family</code> column.</p>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>reflectance_df <span class="op">=</span> pd.DataFrame.from_records(records)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># display the updated dataframe, which now includes the reflectance values for all </span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>reflectance_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Display the unique taxonIDs and families represented in this training data set:</p>
<div id="cell-85" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>reflectance_df.taxonID.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-86" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>reflectance_df.family.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we can manipulate the dataframe using <code>melt</code> to reshape the data and make it easier to display the reflectance spectra for each family. This is a helpful first step to visualizing the data and understanding what we’re working with before getting into the classification model.</p>
<p>After re-shaping, we can make a figure to display what the spectra look like for the different families that were recorded as part of the vegetation structure data.</p>
<div id="cell-88" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Melt (re-shape) the dataframe; wavelength columns start with 'refl_'</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>melted_df <span class="op">=</span> reflectance_df.melt(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span>[<span class="st">'family'</span>, <span class="st">'adjEasting'</span>, <span class="st">'adjNorthing'</span>],</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[col <span class="cf">for</span> col <span class="kw">in</span> reflectance_df.columns <span class="cf">if</span> col.startswith(<span class="st">'refl_'</span>)],</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">'wavelength'</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">'reflectance'</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert 'wavelength' from 'refl_XXX' to integer</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>melted_df[<span class="st">'wavelength'</span>] <span class="op">=</span> melted_df[<span class="st">'wavelength'</span>].<span class="bu">str</span>.replace(<span class="st">'refl_'</span>, <span class="st">''</span>).astype(<span class="bu">int</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a summary dataframe that aggregates statistics (mean, min, and max)</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> (</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    melted_df</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">'family'</span>, <span class="st">'wavelength'</span>])</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    .reflectance</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">'mean'</span>, <span class="st">'min'</span>, <span class="st">'max'</span>])</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color palette</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> sns.color_palette(<span class="st">'hls'</span>, n_colors<span class="op">=</span>summary_df[<span class="st">'family'</span>].nunique())</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the mean reflectance spectra for each family, filling with semi-transparent color between the min and max value</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (family, group) <span class="kw">in</span> <span class="bu">enumerate</span>(summary_df.groupby(<span class="st">'family'</span>)):</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(family)</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> family <span class="kw">in</span> [<span class="st">'Fagaceae'</span>,<span class="st">'Magnoliaceae'</span>,<span class="st">'Hamamelidaceae'</span>,<span class="st">'Juglandaceae'</span>,<span class="st">'Aceraceae'</span>]:</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot mean line</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>        plt.plot(group[<span class="st">'wavelength'</span>], group[<span class="st">'mean'</span>], label<span class="op">=</span>family, color<span class="op">=</span>palette[i])</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot min-max fill</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>            group[<span class="st">'wavelength'</span>],</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>            group[<span class="st">'min'</span>],</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>            group[<span class="st">'max'</span>],</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>palette[i],</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Wavelength'</span>)</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Reflectance'</span>)</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Reflectance Spectra by Family </span><span class="ch">\n</span><span class="st"> (with Min/Max Range)'</span>)</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'family'</span>)</span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that the spectral signatures for the different families have similar shapes, and there is a decent amount of spread in the reflectance values for each family. Some of this spread may be due to the cloud conditions during the time of acquisition. Reflectance values of one species may vary depending on how cloudy it was, or whether there was a cloud obscuring the sun during the collection. The random forest model may not be able to fully distinguish between the different families based on their spectral signatures, but we will see!</p>
</section>
<section id="set-up-the-random-forest-model-to-classify-tree-families" class="level3">
<h3 class="anchored" data-anchor-id="set-up-the-random-forest-model-to-classify-tree-families">5.3 Set up the Random Forest Model to Classify Tree Families</h3>
<p>We can set up our random forest model by following the steps below:</p>
<ol type="1">
<li>Prepare the training data by dropping the <code>family</code> column and setting the <code>family</code> column as the target variable. Remove the bad bands (NaN) from the reflectance predictor variables.</li>
<li>Split the data into training and testing sets.</li>
<li>Train the random forest model on the training data.</li>
<li>Evaluate the model on the testing data.</li>
<li>Visualize the results.</li>
</ol>
<p>We will need to import scikit-learn (sklearn) packages in order to run the random forest model. If you don’t have these packages installed, you can install them using <code>!pip install scikit-learn</code>.</p>
<div id="cell-91" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, accuracy_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prepare-and-clean-the-training-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-and-clean-the-training-data">5.4 Prepare and clean the training data</h3>
<div id="cell-93" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Prepare the Data</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify reflectance columns</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>refl_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> reflectance_df.columns <span class="cf">if</span> col.startswith(<span class="st">'refl_'</span>)]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with any NaN in reflectance columns (these are the 'bad bands')</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>clean_df <span class="op">=</span> reflectance_df.dropna(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># re-define refl_columns after removing the ones that are all NaN</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>refl_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> clean_df.columns <span class="cf">if</span> col.startswith(<span class="st">'refl_'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-94" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># display the cleaned dataframe</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>clean_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we have &gt; 360 predictor variables (reflectance values for each band), and only 100 training points, so the model may not perform very well, due to over fitting. You can try increasing the number of training points by using more of the training data, or by using a different classification algorithm. Recall that we just pulled woody vegetation data from this tile that covers the tower, and there are also data collected throughout the rest of the TOS terrestrial sampling plots, so you could pull in more training data from the other tiles as well. You would likely not need all of the reflectance bands - for example, you could take every 2nd or 3rd band, or perform a PCA to reduce the number of bands. These are all things you could test as part of your model. For this lesson, we will include all of the valid reflectance bands for the sake of simplicity.</p>
<p>That said, we will need to remove some of the families that are poorly represented in the training data, as they will not be able to be predicted by the model. We can do this by filtering out families that have less than 10 training points. If you leave these in, the model will not be able to predict them, and will return an error when you try to evaluate the model.</p>
<div id="cell-96" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># determine the number of training data points for each family</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>clean_df[[<span class="st">'taxonID'</span>,<span class="st">'family'</span>]].groupby(<span class="st">'family'</span>).count().sort_values(<span class="st">'taxonID'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-97" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the rows where there are fewer than 10 samples</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># List of families to remove</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>families_to_remove <span class="op">=</span> [<span class="st">'Rosaceae'</span>, <span class="st">'Pinaceae'</span>, <span class="st">'Ulmaceae'</span>]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows where family is in the families_to_remove list</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>clean_df <span class="op">=</span> clean_df[<span class="op">~</span>clean_df[<span class="st">'family'</span>].isin(families_to_remove)].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="encode-the-target-variable" class="level3">
<h3 class="anchored" data-anchor-id="encode-the-target-variable">5.5 Encode the target variable</h3>
<p>Next we need to encode the target variable (family) as integers, so that the model can work properly. Encoding is the process of converting from human-readable text (words / characters) to the byte representations used by computers. We can do this using the <code>LabelEncoder</code> from scikit-learn.</p>
<div id="cell-99" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode the Target Variable (family)</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Machine learning models require numeric targets. Use LabelEncoder:</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>le <span class="op">=</span> LabelEncoder()</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>clean_df[<span class="st">'family_encoded'</span>] <span class="op">=</span> le.fit_transform(clean_df[<span class="st">'family'</span>])</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the cleaned dataframe after encoding the target variable</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>clean_df[[<span class="st">'taxonID'</span>,<span class="st">'family'</span>,<span class="st">'family_encoded'</span>,<span class="st">'adjEasting'</span>,<span class="st">'adjNorthing'</span>,<span class="st">'refl_381'</span>,<span class="st">'refl_2461'</span>]].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-100" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm that the number of unique encodings is the same as the number of unique families, as a sanity check</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>clean_df[<span class="st">'family_encoded'</span>].nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="split-the-data-into-training-and-testing-sets" class="level3">
<h3 class="anchored" data-anchor-id="split-the-data-into-training-and-testing-sets">5.6 Split the data into training and testing sets</h3>
<p>In this next step, we will split the data into training and testing sets. We will use 80% of the data for training and 20% for testing (this is the default split). This is a common practice in machine learning to test the performance of the model, and to ensure that the model is able to generalize to new data (e.g.&nbsp;you’re not over-fitting).</p>
<div id="cell-102" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split Data into Train/Test Sets</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> clean_df[refl_cols].values</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> clean_df[<span class="st">'family_encoded'</span>].values</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, stratify<span class="op">=</span>y, random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-random-forest-classifier-object" class="level3">
<h3 class="anchored" data-anchor-id="create-a-random-forest-classifier-object">5.7 Create a Random Forest Classifier Object</h3>
<div id="cell-104" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Random Forest Classifier object and fit it to the training data</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>clf.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluate-the-model" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-the-model">5.8 Evaluate the Model</h3>
<div id="cell-106" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the accuracy scores based off of the test set</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> clf.predict(X_test)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Accuracy:"</span>, accuracy_score(y_test, y_pred))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, y_pred, target_names<span class="op">=</span>le.classes_))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What do these accuracy metrics mean?</p>
<ul>
<li><p><strong>Precision</strong>: Of the items predicted as a given class, what fraction were actually that class?<br>
(Precision = True Positives / (True Positives + False Positives))</p></li>
<li><p><strong>Recall</strong>: Of all actual items of a given class, what fraction were correctly predicted?<br>
(Recall = True Positives / (True Positives + False Negatives))</p></li>
<li><p><strong>F1-score</strong>: The harmonic mean of precision and recall. It balances both metrics.<br>
(F1 = 2 * (Precision * Recall) / (Precision + Recall))</p></li>
<li><p><strong>Support</strong>: The number of true instances of each class in the dataset (i.e., how many samples belong to each class).</p></li>
</ul>
<p>These metrics are commonly used to evaluate classification models. Ideally we would be closer to 1 for the precision, recall, and f1-scores, which would indicate that the model is performing well. The support values indicate how many training points were used for each family, and you can see that some families have very few training points, which is likely negatively impacting the model performance.</p>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>Great job! You now should have a fairly good grasp on working with NEON airborne and field datasets together.</p>
<p>What are some things you could do to improve the classification results?</p>
<p>Models are only as good as the underlying training data - so the better the training data (more + higher quality training data points) the better your results will be.</p>
<p>You could consider some of the following options:</p>
<ol type="1">
<li><strong>Increase the number of training points</strong>: Use more training data from the other plots (and use more AOP tiles). You could also collect your own additional data within the NEON site.</li>
<li><strong>Filter out sub-optimal data</strong>: Remove training points that were collected in poor weather conditions (e.g.&nbsp;&gt; 10% cloud cover), or that are outliers (e.g.&nbsp;due to spatial mis-match, shadowing, or other issues).</li>
<li><strong>Average the reflectance values over an entire tree crown</strong>: In this example, we just pulled the reflectance values from a single pixel, but you could average the reflectance values over an entire tree crown to get a more representative value for each tree. If part of the tree is in shadow, you may want to remove that pixel from the average.</li>
<li><strong>Tune the model parameters</strong>: You can adjust the hyperparameters of the random forest model, such as the number of trees, maximum depth, and minimum samples per leaf, to improve performance.</li>
<li><strong>Use a different classification algorithm</strong>: Random forest is a good starting point, but you could also try other algorithms such as support vector machines, gradient boosting, or neural networks to see if they perform better.</li>
</ol>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p>In this example, we just scratched the surface of what you can do with NEON reflectance data. Here are some next steps you could take to further explore and analyze the data:</p>
<ol type="1">
<li><strong>Apply the model to the entire reflectance dataset</strong>: Use the trained model to predict the tree families for all pixels in the reflectance dataset, and visualize the results. You may wish to include more training data for non-tree species, since the AOP data also captures non-vegetation such as water bodies, buildings, roads, etc.</li>
<li><strong>Try out the same model on SERC AOP data that was acquired in better weather conditions</strong>: Use the reflectance data from SERC 2017, which was collected in clearer weather conditions, to see if the model performs better. Note that you may need to make some minor modifications to the <code>aop_h5refl2xarray</code> function to accommodate the slightly different data structure of the directional reflectance data product (2019 data is not yet available with BRDF and topographic corrections, as of August 2025).</li>
<li><strong>Explore other NEON sites</strong>: Use the <code>neonutilities</code> package to explore reflectance data from other NEON sites, and compare the spectral signatures of different land cover types.</li>
<li><strong>Add in other NEON AOP datasets</strong>: In this lesson, we only looked at the reflectance data. How might other NEON data products compliment this analysis? For example, you could look at the lidar data to get information about the structure of the vegetation, for example the Canopy Height Model (CHM) or the Digital Surface Model (DSM). You could also look at the AOP imagery data.</li>
<li><strong>Use the reflectance data for other applications</strong>: The reflectance data can be used for a variety of applications, such as mapping vegetation health, detecting disease or invasive species, and mapping droughts, wildfires, or other natural disturbances and their impacts. You could use a similar approach to explore some of these applications.</li>
</ol>
<div id="cell-108" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Challenge Solution: Apply the model to the full AOP reflectance data tile at SERC</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Prepare the data:</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the reflectance array from your xarray Dataset:</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>refl <span class="op">=</span> serc_refl_xr[<span class="st">'reflectance'</span>].values  <span class="co"># shape: (y, x, bands)</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the bad bands so that we can apply the model, which only uses 363 bands</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>good_bands <span class="op">=</span> serc_refl_xr[<span class="st">'good_wavelengths'</span>].values.astype(<span class="bu">bool</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>refl_good <span class="op">=</span> refl[:, :, good_bands]         <span class="co"># shape: (y, x, n_good_bands)</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Reshape for prediction:</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>nrows, ncols, nbands <span class="op">=</span> refl_good.shape</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>refl_2d <span class="op">=</span> refl_good.reshape(<span class="op">-</span><span class="dv">1</span>, nbands)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Apply the model:</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the trained random forest model (e.g., rf_model) to predict values for every pixel</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> clf.predict(refl_2d)</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Reshape predictions back to image (y, x):</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>pred_map <span class="op">=</span> preds.reshape(nrows, ncols)</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Create an xarray DataArray for mapping, using the coordinates from your original data:</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>pred_xr <span class="op">=</span> xr.DataArray(</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    pred_map,</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">=</span>(<span class="st">'y'</span>, <span class="st">'x'</span>),</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>    coords<span class="op">=</span>{<span class="st">'y'</span>: serc_refl_xr[<span class="st">'y'</span>], <span class="st">'x'</span>: serc_refl_xr[<span class="st">'x'</span>]},</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'classification_prediction'</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Plot the map, using hvplot to visualize:</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="co"># pred_xr.hvplot.image(x='x', y='y', cmap='tab20', title='Random Forest Classification Map')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-109" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> le.classes_</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'classes:'</span>, classes)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>class_labels <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">enumerate</span>(classes))</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'class labels:'</span>,class_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-110" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert your prediction DataArray to a categorical type with labels:</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>pred_xr_labeled <span class="op">=</span> pred_xr.copy()</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>pred_xr_labeled <span class="op">=</span> pred_xr_labeled.assign_coords(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    family<span class="op">=</span>((<span class="st">'y'</span>, <span class="st">'x'</span>), np.vectorize(class_labels.get)(pred_xr.values))</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-111" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the classification map, using hvplot to visualize:</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap, BoundaryNorm</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using hvplot with the family coordinate as the color dimension:</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>family_codes <span class="op">=</span> np.arange(<span class="dv">7</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>family_names <span class="op">=</span> classes</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose 7 distinct colors (can use tab10, Set1, or your own)</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> plt.get_cmap(<span class="st">'tab10'</span>).colors[:<span class="dv">7</span>]  <span class="co"># 7 distinct colors from tab10</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping from code to color</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>code_to_color <span class="op">=</span> {code: colors[i] <span class="cf">for</span> i, code <span class="kw">in</span> <span class="bu">enumerate</span>(family_codes)}</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>cmap <span class="op">=</span> ListedColormap([code_to_color[code] <span class="cf">for</span> code <span class="kw">in</span> family_codes])</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>pred_xr_labeled.hvplot.image(</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'x'</span>, y<span class="op">=</span><span class="st">'y'</span>, groupby<span class="op">=</span>[], color<span class="op">=</span><span class="st">'family'</span>, cmap<span class="op">=</span>cmap,</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Random Forest Classification Map'</span>, frame_width<span class="op">=</span><span class="dv">600</span>, frame_height<span class="op">=</span><span class="dv">600</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>).opts(xformatter<span class="op">=</span><span class="st">'%.0f'</span>, yformatter<span class="op">=</span><span class="st">'%.0f'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-112" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Create a custom colorbar for the classification map</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap, BoundaryNorm</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">1</span>))</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>fig.subplots_adjust(bottom<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a colormap and norm</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>cmap <span class="op">=</span> ListedColormap([code_to_color[code] <span class="cf">for</span> code <span class="kw">in</span> family_codes])</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>norm <span class="op">=</span> BoundaryNorm(np.arange(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">7.5</span>, <span class="dv">1</span>), cmap.N)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create colorbar</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>cb <span class="op">=</span> plt.colorbar(</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    plt.cm.ScalarMappable(norm<span class="op">=</span>norm, cmap<span class="op">=</span>cmap),</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    cax<span class="op">=</span>ax, orientation<span class="op">=</span><span class="st">'horizontal'</span>, ticks<span class="op">=</span>family_codes</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>cb.ax.set_xticklabels(family_names,fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>cb.set_label(<span class="st">'Family'</span>)</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="acknowledgements" class="level3">
<h3 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h3>
<p>Much of this tutorial was inspired by and adapated from lessons in the <a href="https://github.com/nasa/VITALS/tree/main/python">NASA VITALS GitHub Repository</a>. Thank you!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/NEONScience\.github\.io\/neon-nasa-hsi-workshop\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../neon/01_make-classification-training-df.html" class="pagination-link" aria-label="1 NEON - Make a Training Dataset from Vegetation Structure Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">1 NEON - Make a Training Dataset from Vegetation Structure Data</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../resources/additional_resources.html" class="pagination-link" aria-label="Additional Resources">
        <span class="nav-page-text">Additional Resources</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>NASA and NEON Airborne Hyperspectral Workshop - ESA 2025</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>